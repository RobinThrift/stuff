{{ template "layout.html.tmpl" . }}

{{ define "header" }}
{{ with .Data }}
<h1 class="font-extrabold md:text-2xl lg:text-4xl">
{{ if .IsNew }}
	New Asset
{{ else }}
	Editing "{{ .Asset.Name }}"
{{ end }}
</h1>
{{ end }}
{{ end }}

{{ define "main" }}
{{ with .Data }}
<form
	class="main"
	method="post"
	action="{{- if .IsNew -}} /assets/new {{- else -}} {{ printf "/assets/%v/edit" .Asset.ID }} {{- end -}}"
	enctype="multipart/form-data"
>
	{{ if has .ValidationErrs "general" }}
	<span class="block text-red-500">{{ .ValidationErrs.general }}</span>
	{{ end }}

	<input type="hidden" name="stuff.csrf.token" value="{{ $.Global.CSRFToken }}" />

	<div class="w-full flex flex-col lg:flex-row">
		<div class="flex-1 order-1">
			<h3 class="pb-3 col-span-4 font-bold text-lg md:text-xl">General Information</h3>
			<div class="p-5 border-b mb-5 lg:mb-0 lg:border border-gray-300 lg:rounded-md flex flex-col md:col-span-3 md:gap-5 md:grid md:grid-cols-4">
				{{-
					template "field" dict
					"Class" "col-span-3 mb-3"
					"InputWrapperClass" "flex-grow"
					"LabelClass" "font-bold"
					"Required" true
					"Label" "Name"
					"Name" "name"
					"ValidationErr" .ValidationErrs.name
					"Value" .Asset.Name
				-}}

				{{-
					template "select" dict
					"Class" "col-span-1 mb-3"
					"Label" "Status"
					"LabelClass" "font-bold"
					"Name" "status"
					"ValidationErr" .ValidationErrs.status
					"Value" .Asset.Status
					"Options" (list
						(list "In Storage" "IN_STORAGE")
						(list "In Use" "IN_USE")
						(list "Archived" "ARCHIVED")
					)
				-}}

				{{-
					template "field" dict
					"Class" "col-span-2 mt-3"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Required" true
					"Label" "Tag"
					"Name" "tag"
					"ValidationErr" .ValidationErrs.tag
					"Value" .Asset.Tag
					"AutoCompleteSource" "/api/v1/tags?in_use=false"
					"AutoCompleteItemsAt" "tags"
					"AutoCompleteValueAt" "tag"
				-}}

				{{-
					template "field" dict
					"Class" "col-span-2 mt-3"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Required" true
					"Label" "Category"
					"Name" "category"
					"ValidationErr" .ValidationErrs.category
					"Value" .Asset.Category
					"AutoCompleteSource" "/api/v1/assets/categories"
					"AutoCompleteItemsAt" "categories"
					"AutoCompleteValueAt" "name"
				-}}

				{{-
					template "field" dict
					"Class" "col-span-2 mt-3"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Label" "Model"
					"Name" "model"
					"ValidationErr" .ValidationErrs.model
					"Value" .Asset.Model
				-}}

				{{-
					template "field" dict
					"Class" "col-span-2 mt-3"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Label" "Model No."
					"Name" "model_no"
					"ValidationErr" .ValidationErrs.model_no
					"Value" .Asset.ModelNo
				-}}

				{{-
					template "field" dict
					"Class" "col-span-2 mt-3"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Label" "Manufacturer"
					"Name" "manufacturer"
					"ValidationErr" .ValidationErrs.manufacturer
					"Value" .Asset.Manufacturer
				-}}

				{{-
					template "field" dict
					"Class" "col-span-2 mt-3"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Label" "Serial No"
					"Name" "serial_no"
					"ValidationErr" .ValidationErrs.serial_no
					"Value" .Asset.SerialNo
				-}}

				{{-
					template "datepicker" dict
					"Class" "col-span-1 col-start-4 mt-3"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Label" "Warranty Until"
					"Name" "warranty_until"
					"ValidationErr" .ValidationErrs.warranty_until
					"Value" .Asset.WarrantyUntil
					"Format" "2006-01-02"
				-}}

				{{-
					template "textarea" dict
					"Class" "col-span-4 mt-3"
					"LabelClass" "font-bold"
					"Label" "Notes"
					"Name" "notes"
					"ValidationErr" .ValidationErrs.notes
					"Value" .Asset.Notes
				-}}

				{{-
					template "field" dict
					"Class" "col-span-2 mt-3"
					"LabelClass" "font-bold text-lg"
					"InputWrapperClass" "flex-grow"
					"Label" "Belongs To"
					"Name" "parent_asset_id"
					"ValidationErr" .ValidationErrs.parent_asset_id
					"Value" (default .Asset.ParentAssetID "")
					"AutoCompleteSource" "/api/v1/assets"
					"AutoCompleteItemsAt" "assets"
					"AutoCompleteLabelAt" "name"
					"AutoCompleteValueAt" "id"
				-}}
			</div>
		</div>

		<div class="order-3 lg:order-2 lg:w-1/3">
			<h3 class="px-3 pb-3 col-span-4 font-bold text-lg md:text-xl">Location</h3>
			<div class="p-5 border-b mb-5 lg:border border-gray-300 lg:rounded-md flex flex-col md:grid md:grid-cols-4 lg:ms-2 flex flex-col md:col-span-3 md:gap-5 md:grid md:grid-cols-4">
				{{-
					template "field" dict
					"Class" "col-span-3 mb-3 lg:mb-0"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Label" "Location"
					"Name" "location"
					"ValidationErr" .ValidationErrs.location
					"Value" .Asset.Location
				-}}

				{{-
					template "field" dict
					"Class" "col-span-1"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Label" "Position Code"
					"Name" "position_code"
					"ValidationErr" .ValidationErrs.position_code
					"Value" .Asset.PositionCode
				-}}
			</div>

			<h3 class="mt-2 px-3 pb-3 col-span-4 font-bold text-lg md:text-xl">PurchaseInfo</h3>
			<div class="p-5 border-b mb-5 lg:mb-0 lg:border border-gray-300 lg:rounded-md flex flex-col md:grid md:grid-cols-4 lg:ms-2 flex flex-col md:col-span-3 md:gap-5 md:grid md:grid-cols-4">
				{{-
					template "field" dict
					"Class" "col-span-3 mb-3"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Label" "Order No."
					"Name" "purchase.order_no"
					"ValidationErr" (index .ValidationErrs "purchase.order_no")
					"Value" .Asset.PurchaseInfo.OrderNo
				-}}

				{{-
					template "datepicker" dict
					"Class" "col-span-1 mb-3"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Label" "Purchase Date"
					"Name" "purchase.date"
					"Format" "2006-01-02"
					"ValidationErr" (index .ValidationErrs "purchase.date")
					"Value" .Asset.PurchaseInfo.Date
				-}}

				{{-
					template "field" dict
					"Class" "col-span-4 mb-3"
					"LabelClass" "font-bold"
					"InputWrapperClass" "flex-grow"
					"Label" "Supplier"
					"Name" "purchase.supplier"
					"ValidationErr" (index .ValidationErrs "purchase.supplier")
					"Value" .Asset.PurchaseInfo.Supplier
				-}}

				<div class="md:col-span-1 md:col-start-4 flex items-center mb-5 mt-3 lg:mt-0">
					<label for="purchase.amount" class="label font-bold mt-2 mr-5 flex items-center">Cost</label>
					<div class="flex-grow flex w-full items-center">
						<input name="purchase.amount" id="purchase.amount" class="input rounded-r-none min-w-[90px] flex-1 text-right" value="{{ .Asset.PurchaseInfo.Amount.Format .DecimalSeparator }}" />
						<input
							type="text"
							name="purchase.currency"
							id="purchase.currency"
							value="{{ .Asset.PurchaseInfo.Currency }}"
							class="input rounded-l-none w-[64px] border-l-0"
						/>

						{{ if has .ValidationErrs "purchase.amount" }}
						<span class="block text-red-500">{{ (index .ValidationErrs "purchase.amount") }}</span>
						{{ end }}
					</div>
				</div>
			</div>
		</div>

		<div class="w-full order-2 lg:order-3 lg:w-1/5 xl:w-1/4">
			<h3 class="px-3 pb-3 col-span-4 font-bold text-lg md:text-xl">Image</h3>
			<div class="h-96 lg:ms-2 border-b mb-5 lg:mb-0 lg:border border-gray-300 lg:rounded-md flex flex-col items-center justify-center" x-data="{{ printf "{ img: '%s' }" .Asset.ImageURL }}">
				<label
					for="image"
					class="block w-full cursor-pointer relative"
					x-on:dragover.prevent="$refs.icons.classList.add('drag-over')"
					x-on:dragleave.prevent="$refs.icons.classList.remove('drag-over')" 
				>
					<div class="flex flex-col items-center justify-center">
						<div x-show="!img" class="group flex justify-center items-center w-full h-full" x-ref="icons">
							<x-icon icon="file-arrow-up" class="drag-over-show pointer-events-none" />
							<x-icon icon="images-square" class="drag-over-hide pointer-events-none" />
						</div>

						<p x-show="!img" class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Drop to upload</span> or click to select</p>
						<p x-show="!img" class="text-xs text-gray-500 dark:text-gray-400">PNG, JPEG, WebP</p>

						<img x-show="img" x-bind:src="img" class="w-auto h-full max-h-72" />
					</div>

					<input
						class="absolute top-0 left-0 bottom-0 right-0 text-sm file:text-transparent text-transparent file:border-0 file:bg-transparent"
						name="image"
						id="image"
						type="file"
						accept="image/*"
						x-ref="fileInput"
						x-on:change="
							if (!$event.target.files) {
								return
							}
							reader = new FileReader();
							reader.readAsDataURL($event.target.files[0])
							reader.onload = e => img = e.target.result
						"
					/>
				</label>

				<button
					x-cloak x-show="img" class="btn btn-outline btn-danger flex justify-center items-center"
					x-on:click.prevent="$refs.fileInput.value = ''; img = ''"
				>
					<x-icon icon="file-x" class="w-[24px] h-[24px]" />
					Clear
				</button>
			</div>
		</div>
	</div>

	{{ template "edit_parts" .Asset }}

	<div class="flex flex-col items-end">
		<button type="submit" class="btn btn-primary mt-5">
			Save Asset
		</button>
	</div>
</form>
{{ end }}
{{ end }}


{{ define "edit_parts" }}
<div
	class="w-full"
	x-data="{{
		printf `{
			parts: %v ?? [],
			parentTag: '%v',
			totalCounter: %v,

			addItem() {
				this.totalCounter++
				this.parts.push({
					ID: 0,
					Tag: this.parentTag + '-' + this.totalCounter,
					Name: '',
					Location: '',
					PositionCode: '',
					Notes: '',
				})
			},

			removeItem(i) {
				console.log(this.parts.splice(i, 1))
			}
		}` (json .Parts) .Tag .PartsTotalCounter
	}}"
>
	<input required="true" type="hidden" name="parts_total_counter" id="parts_total_counter" x-bind:value="totalCounter">

	<h2 class="mt-8 mb-5 md:text-xl lg:text-3xl font-bold">Parts</h2>
	<table class="w-full">
		<thead>
			<tr class="text-left">
				<th>Tag</th>
				<th>Name</th>
				<th>Location</th>
				<th>Position Code</th>
				<th>Notes</th>
				<th></th>
			</tr>
		</thead>

		<tbody>
			<template x-for="(part, i) in parts">
				<tr>
					<td class="pe-3 last:pe-0">
						<input type="hidden" x-bind:name="`parts[${i}].id`" x-bind:value="part.ID" />
						{{-
							template "field" dict
							"Required" true
							"Readonly" true
							"XBindName" "`parts[${i}].tag`"
							"XBindValue" "part.Tag"
						-}}
					</td>

					<td class="pe-3 last:pe-0">
						{{-
							template "field" dict
							"Required" true
							"Placeholder" "Name"
							"XBindName" "`parts[${i}].name`"
							"XBindValue" "part.Name"
						-}}
					</td>

					<td class="pe-3 last:pe-0">
						{{-
							template "field" dict
							"Required" true
							"Placeholder" "Location"
							"XBindName" "`parts[${i}].location`"
							"XBindValue" "part.Location"
						-}}
					</td>

					<td class="pe-3 last:pe-0">
						{{-
							template "field" dict
							"Required" true
							"Placeholder" "Position Code"
							"XBindName" "`parts[${i}].position_code`"
							"XBindValue" "part.PositionCode"
						-}}
					</td>

					<td class="pe-3 last:pe-0">
						{{-
							template "textarea" dict
							"InputClass" "mt-1"
							"MinHeight" "min-h-[42px]"
							"Placeholder" "Notes"
							"XBindName" "`parts[${i}].notes`"
							"XBindValue" "part.Notes"
						-}}
					</td>

					<td>
						<button class="btn btn-danger h-8 mt-1" x-on:click.prevent="removeItem(i)"><x-icon icon="x-square" class="w-6 h-6 !me-0" /></button>
					</td>
				</tr>
			</template>
		</tbody>
	</table>

	<button class="btn btn-secondary mt-5" x-on:click.prevent="addItem()">Add Part</button>
</div>
{{ end }}
